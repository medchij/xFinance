// Polaris NES API-–∞–∞—Å –∑—ç—ç–ª–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª —Ç–∞—Ç–∞—Ö —Ñ—É–Ω–∫—Ü
export async function fetchPolarisLoanData(setMessage, setLoading) {
  return withLoading(setLoading, setMessage, async () => {
    await Excel.run(async (context) => {
      setMessage("‚è≥ Polaris –∑—ç—ç–ª —Ç–∞—Ç–∞—Ö —ç—Ö—ç–ª–ª—ç—ç...");

      // 1. –ò–¥—ç–≤—Ö—Ç—ç–π cell-—ç—ç—Å –∑—ç—ç–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä —É–Ω—à–∏—Ö
      const activeCell = context.workbook.getSelectedRange();
      activeCell.load("values");
      await context.sync();

      const loanNumber = activeCell.values[0][0];
      if (!loanNumber) {
        throw new Error("‚ö†Ô∏è –ó—ç—ç–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä –æ—Ä—É—É–ª–Ω–∞ —É—É!");
      }

      // 2. –ó—ç—ç–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä –≤–∞–ª–∏–¥–∞—Ü–∏ (16+ —Ç—ç–º–¥—ç–≥—Ç, "1221"-—ç—ç—Ä —ç—Ö—ç–ª–Ω—ç)
      if (loanNumber.toString().length < 16 || !loanNumber.toString().startsWith("1221")) {
        throw new Error("‚ö†Ô∏è –ó—ç—ç–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä –±—É—Ä—É—É –±–∞–π–Ω–∞. 16+ —Ç—ç–º–¥—ç–≥—Ç, '1221'-—ç—ç—Ä —ç—Ö—ç–ª–Ω—ç.");
      }

      console.log("üîç Polaris request:", { loanNumber });
      setMessage("‚è≥ Backend API —Ä—É—É —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...");

      // 3. Backend proxy-–∞–∞—Ä –¥–∞–º–∂—É—É–ª–∞–Ω Polaris API —Ä—É—É —Ö–∞–Ω–¥–∞—Ö (CORS —à–∏–π–¥—ç–ª)
      // Authorization header –Ω—ç–º—ç—Ö (JWT token)
      const token = localStorage.getItem('authToken');
      
      const response = await fetch(`${BASE_URL}/api/polaris/loan-data`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({
          loanNumber: loanNumber.toString(),
        }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || `‚ùå API —Ö“Ø—Å—ç–ª—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π: ${response.status}`);
      }

      const parsedResult = await parseJsonSafe(response);

      // 4. repayAcntCode-–∏–π–≥ –æ–ª–∂ –∞–≤–∞—Ö
      const repayAcntCode = parsedResult?.repayAcntCode || "";
      const loanname = parsedResult?.name || "";
      
      // 5. “Æ—Ä –¥“Ø–Ω–≥ –∏–¥—ç–≤—Ö—Ç—ç–π cell-–∏–π–Ω —Ö–∞–∂—É—É–¥ –±–∏—á–∏—Ö (–±–∞–≥–∞–Ω–∞ 1: repayAcntCode)
      const resultCell1 = activeCell.getOffsetRange(0, 1);
      resultCell1.values = [["'" + repayAcntCode]];
      const resultCellLoanName = activeCell.getOffsetRange(0, 2);
      resultCellLoanName.values = [[loanname]];
      // 6. –ë“Ø—Ö —Ö–∞—Ä–∏—É–≥ JSON —Ñ–æ—Ä–º–∞—Ç–∞–∞—Ä –≥–∞—Ä–≥–∞—Ö (–±–∞–≥–∞–Ω–∞ 2: –±“Ø—Ö —Ö–∞—Ä–∏—É)
     // const resultCell2 = activeCell.getOffsetRange(0, 2);
      //const fullResponse = JSON.stringify(parsedResult, null, 2);
      //resultCell2.values = [[fullResponse]];
      
      await context.sync();

      setMessage(`‚úÖ Polaris-–∞–∞—Å –º—ç–¥—ç—ç–ª—ç–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ç–∞—Ç–∞–≥–¥–ª–∞–∞. –ó—ç—ç–ª–∏–π–Ω –¥—É–≥–∞–∞—Ä: ${loanNumber}`);
    });
  });
}

/**
 * Polaris NES —Å–∏—Å—Ç–µ–º—ç—ç—Å –∑—ç—ç–ª–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö
 * @param {function} setMessage - –ú—ç–¥—ç–≥–¥—ç–ª —Ö–∞—Ä—É—É–ª–∞—Ö —Ñ—É–Ω–∫—Ü
 * @param {function} setLoading - Loading —Ç”©–ª”©curlcurlcurlcurlcurlcurlcurlcurlcurlcurl -X POST http://localhost:4000/api/polaris/customer-list ^
  -H "Content-Type: application/json" ^
  -d "{\"status\":[\"1\"],\"page\":0,\"pageSize\":10}" * @param {Object} filters - –®“Ø“Ø–ª—Ç“Ø“Ø—Ä {status: ['O','N'], branchCode: '122101', prodType: ['LOAN','LINE']}
 */
export async function fetchPolarisLoanList(setMessage, setLoading, filters = {}) {
  return withLoading(setLoading, setMessage, async () => {
    await Excel.run(async (context) => {
      setMessage("‚è≥ Polaris –∑—ç—ç–ª–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö —ç—Ö—ç–ª–ª—ç—ç...");

      // 1. –®“Ø“Ø–ª—Ç“Ø“Ø—Ä –±—ç–ª—Ç–≥—ç—Ö (defaults)
      const {
        status = ['O', 'N'],
        branchCode = '122101',
        prodType = ['LOAN', 'LINE'],
        page = 0,
        pageSize = 25
      } = filters;

      console.log("üîç Polaris loan list request:", { status, branchCode, prodType, page, pageSize });
      setMessage("‚è≥ Backend API —Ä—É—É —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...");

      // 2. Backend proxy-–∞–∞—Ä –¥–∞–º–∂—É—É–ª–∞–Ω Polaris API —Ä—É—É —Ö–∞–Ω–¥–∞—Ö (JWT token)
      const token = localStorage.getItem('authToken');
      
      const response = await fetch(`${BASE_URL}/api/polaris/loan-list`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({
          status,
          branchCode,
          prodType,
          page,
          pageSize
        }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`‚ùå API —Ö“Ø—Å—ç–ª—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π: ${response.status}. ${errorText.substring(0, 200)}`);
      }

      const parsedResult = await parseJsonSafe(response);

      // 3. –®–∏–Ω—ç worksheet “Ø“Ø—Å–≥—ç—Ö
      const newSheetName = buildSheetName('Polaris');
      
      const newSheet = context.workbook.worksheets.add(newSheetName);
      newSheet.activate();
      await context.sync();

      // 4. –•–∞—Ä–∏—É –º–∞—Å—Å–∏–≤ –±–∞–π–≤–∞–ª –±“Ø—Ö —Ç–∞–ª–±–∞—Ä—É—É–¥—ã–≥ –¥–∏–Ω–∞–º–∏–∫–∞–∞—Ä –∑–∞–¥–ª–∞—Ö
      if (Array.isArray(parsedResult) && parsedResult.length > 0) {
        const firstItem = parsedResult[0];
        const headers = Object.keys(firstItem || {});

        if (!headers.length) {
          setMessage("‚ö†Ô∏è API —Ö–∞—Ä–∏—É–Ω–¥ –±–∏—á–∏—Ö —Ç–∞–ª–±–∞—Ä –∞–ª–≥–∞ (headers —Ö–æ–æ—Å–æ–Ω)." );
          return;
        }
        
        // –¢–æ–ª–≥–æ–π –º”©—Ä –±–∏—á–∏—Ö (A1-—ç—ç—Å —ç—Ö–ª—ç—Ö)
        const headerRange = newSheet.getRangeByIndexes(0, 0, 1, headers.length);
        headerRange.values = [headers];
        headerRange.format.font.bold = true;
        headerRange.format.fill.color = "#4472C4";
        headerRange.format.font.color = "white";
        
        // ”®–≥”©–≥–¥”©–ª –º”©—Ä“Ø“Ø–¥–∏–π–≥ –±—ç–ª—Ç–≥—ç—Ö
        const dataRows = parsedResult.map(item => {
          return headers.map(key => {
            const value = item[key];
            if (value === null || value === undefined) return "";
            
            // 16+ –æ—Ä–æ–Ω—Ç–æ–π —Ç–æ–æ–≥ —Ç–µ–∫—Å—Ç –±–æ–ª–≥–æ—Ö (Excel-–∏–π–Ω —Ç–æ–æ–Ω—ã —Ö—è–∑–≥–∞–∞—Ä–ª–∞–ª—Ç)
            if (typeof value === 'string' && /^\d{16,}$/.test(value)) {
              return "'" + value; // –ê–ø–æ—Å—Ç—Ä–æ—Ñ –Ω—ç–º–∂ —Ç–µ–∫—Å—Ç –±–æ–ª–≥–æ—Ö
            }
            return value;
          });
        });
        
        // ”®–≥”©–≥–¥”©–ª –±–∏—á–∏—Ö (A2-–æ–æ—Å —ç—Ö–ª—ç—Ö)
        const dataRange = newSheet.getRangeByIndexes(1, 0, dataRows.length, headers.length);
        dataRange.values = dataRows;
        dataRange.format.autofitColumns();
        
        await context.sync();
        setMessage(`‚úÖ Polaris –∑—ç—ç–ª–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç: ${dataRows.length} –∑—ç—ç–ª, ${headers.length} –±–∞–≥–∞–Ω–∞. Sheet: ${newSheetName}`);
      } else if (Array.isArray(parsedResult) && parsedResult.length === 0) {
        setMessage(`‚ö†Ô∏è Polaris –∑—ç—ç–ª–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.`);
      } else if (typeof parsedResult === 'object' && parsedResult !== null) {
        const entries = Object.entries(parsedResult);
        if (!entries.length) {
          setMessage("‚ö†Ô∏è Polaris —Ö–∞—Ä–∏—É —Ö–æ–æ—Å–æ–Ω –æ–±—ä–µ–∫—Ç –±–∞–π–Ω–∞ (—Ç–∞–ª–±–∞—Ä –∞–ª–≥–∞)." );
          return;
        }

        const dataRows = entries.map(([key, value]) => [
          key,
          typeof value === 'object' ? JSON.stringify(value) : value
        ]);

        const range = newSheet.getRangeByIndexes(0, 0, dataRows.length, 2);
        range.values = dataRows;
        range.format.autofitColumns();

        await context.sync();
        setMessage(`‚úÖ Polaris —Ö–∞—Ä–∏—É: ${entries.length} —Ç–∞–ª–±–∞—Ä. Sheet: ${newSheetName}`);
      } else if (typeof parsedResult === 'string') {
        const cell = newSheet.getRange("A1");
        cell.values = [[parsedResult]];
        await context.sync();
        setMessage(`‚ö†Ô∏è Polaris —Ö–∞—Ä–∏—É —Ç–µ–∫—Å—Ç –±–∞–π–¥–ª–∞–∞—Ä –∏—Ä–ª—ç—ç. Sheet: ${newSheetName}`);
      } else {
        const fullResponse = JSON.stringify(parsedResult, null, 2);
        const cell = newSheet.getRange("A1");
        cell.values = [[fullResponse]];
        await context.sync();
        setMessage(`‚úÖ Polaris —Ö–∞—Ä–∏—É —Ç–∞—Ç–∞–≥–¥–ª–∞–∞. Sheet: ${newSheetName}`);
      }
    });
  });
}

// Polaris NES —Å–∏—Å—Ç–µ–º—ç—ç—Å —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö
export async function fetchPolarisCustomerList(setMessage, setLoading, filters = {}) {
  return withLoading(setLoading, setMessage, async () => {
    await Excel.run(async (context) => {
      setMessage("‚è≥ Polaris —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö —ç—Ö—ç–ª–ª—ç—ç...");

      const {
        status = ['1'],
        page = 2000,
        pageSize = 1000
      } = filters;

      console.log("üîç Polaris customer list request:", { status, page, pageSize });
      setMessage("‚è≥ Backend API —Ä—É—É —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...");

      const token = localStorage.getItem('authToken');

      const response = await fetch(`${BASE_URL}/api/polaris/customer-list`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ status, page, pageSize }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`‚ùå API —Ö“Ø—Å—ç–ª—Ç –∞–º–∂–∏–ª—Ç–≥“Ø–π: ${response.status}. ${errorText.substring(0, 200)}`);
      }

      const parsedResult = await parseJsonSafe(response);

      const newSheetName = buildSheetName('PolarisCustomer');

      const newSheet = context.workbook.worksheets.add(newSheetName);
      newSheet.activate();
      await context.sync();

      if (Array.isArray(parsedResult) && parsedResult.length > 0) {
        const firstItem = parsedResult[0];
        const headers = Object.keys(firstItem || {});

        if (!headers.length) {
          setMessage("‚ö†Ô∏è API —Ö–∞—Ä–∏—É–Ω–¥ –±–∏—á–∏—Ö —Ç–∞–ª–±–∞—Ä –∞–ª–≥–∞ (headers —Ö–æ–æ—Å–æ–Ω)." );
          return;
        }

        const headerRange = newSheet.getRangeByIndexes(0, 0, 1, headers.length);
        headerRange.values = [headers];
        headerRange.format.font.bold = true;
        headerRange.format.fill.color = "#4472C4";
        headerRange.format.font.color = "white";

        const dataRows = parsedResult.map(item => {
          return headers.map(key => {
            const value = item[key];
            if (value === null || value === undefined) return "";
            if (typeof value === 'object') {
              return JSON.stringify(value);
            }
            if (typeof value === 'string' && /^\d{16,}$/.test(value)) {
              return "'" + value;
            }
            return value;
          });
        });

        if (!dataRows.length) {
          setMessage("‚ö†Ô∏è Polaris —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ –º”©—Ä –∞–ª–≥–∞." );
          return;
        }

        const dataRange = newSheet.getRangeByIndexes(1, 0, dataRows.length, headers.length);
        dataRange.values = dataRows;
        dataRange.format.autofitColumns();

        await context.sync();
        setMessage(`‚úÖ Polaris —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç: ${dataRows.length} –º”©—Ä, ${headers.length} –±–∞–≥–∞–Ω–∞. Sheet: ${newSheetName}`);
      } else if (Array.isArray(parsedResult) && parsedResult.length === 0) {
        setMessage(`‚ö†Ô∏è Polaris —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.`);
      } else if (typeof parsedResult === 'object' && parsedResult !== null) {
        const entries = Object.entries(parsedResult);
        const dataRows = entries.map(([key, value]) => [
          key,
          typeof value === 'object' ? JSON.stringify(value) : value
        ]);

        const range = newSheet.getRangeByIndexes(0, 0, dataRows.length, 2);
        range.values = dataRows;
        range.format.autofitColumns();

        await context.sync();
        setMessage(`‚úÖ Polaris —Ö–∞—Ä–∏—É: ${entries.length} —Ç–∞–ª–±–∞—Ä. Sheet: ${newSheetName}`);
      } else {
        const fullResponse = JSON.stringify(parsedResult, null, 2);
        const cell = newSheet.getRange("A1");
        cell.values = [[fullResponse]];
        await context.sync();
        setMessage(`‚úÖ Polaris —Ö–∞—Ä–∏—É —Ç–∞—Ç–∞–≥–¥–ª–∞–∞. Sheet: ${newSheetName}`);
      }
    });
  });
}

netstat -ano | findstr :4000
taskkill /PID 12345 /F